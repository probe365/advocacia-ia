{% extends "base.html" %}

{% block title %}Upload em Massa de Processos{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-upload"></i> Upload em Massa de Processos
                </h2>
                <a href="https://github.com/seu-repo/blob/main/BULK_UPLOAD_GUIDE.md" target="_blank" class="btn btn-sm btn-info">
                    <i class="fas fa-book"></i> Ver Documentação
                </a>
            </div>
            
            {% if cliente %}
            <div class="alert alert-info">
                <strong>Cliente:</strong> {{ cliente.nome_completo if cliente.nome_completo else cliente.get('nome_completo') }}
            </div>
            {% endif %}

            <!-- Informações de Formato -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-file-csv"></i> Formato do Arquivo CSV
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <a href="/processos/api/{{ id_cliente }}/bulk-upload/template" class="btn btn-outline-primary" download>
                                <i class="fas fa-download"></i> Baixar Template
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">O arquivo CSV deve conter as seguintes colunas:</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr class="bg-light">
                                    <th>Coluna</th>
                                    <th>Obrigatório?</th>
                                    <th>Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>nome_caso</code></td>
                                    <td><span class="badge badge-danger">SIM</span></td>
                                    <td>Nome/descrição do processo</td>
                                </tr>
                                <tr>
                                    <td><code>numero_cnj</code></td>
                                    <td><span class="badge badge-warning">Opcional</span></td>
                                    <td>Número CNJ do processo</td>
                                </tr>
                                <tr>
                                    <td><code>status</code></td>
                                    <td><span class="badge badge-warning">Opcional</span></td>
                                    <td>Status do processo (ATIVO, PENDENTE, ENCERRADO)</td>
                                </tr>
                                <tr>
                                    <td><code>advogado_oab</code></td>
                                    <td><span class="badge badge-warning">Opcional</span></td>
                                    <td>OAB do advogado responsável</td>
                                </tr>
                                <tr>
                                    <td><code>tipo_parte</code></td>
                                    <td><span class="badge badge-warning">Opcional</span></td>
                                    <td>Papel do cliente: <code>autor</code>, <code>reu</code>, <code>terceiro</code>, <code>reclamante</code>, <code>reclamada</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-4">Exemplo de CSV:</h6>
                    <pre class="bg-light p-3 rounded"><code>nome_caso,numero_cnj,status,advogado_oab,tipo_parte
"Cobrança de Débito",123456789012345678,ATIVO,SP123456,autor
"Ação Indenizatória",223456789012345679,PENDENTE,SP654321,reu
"Recuperação de Crédito",323456789012345680,ATIVO,SP789012,terceiro</code></pre>

                    <div class="alert alert-warning mt-3 mb-0">
                        <small>
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Dica:</strong> Salve o arquivo como CSV (separado por vírgula) usando UTF-8 como codificação.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Upload Area -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cloud-upload-alt"></i> Selecione ou Arraste seu Arquivo CSV
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Drag and Drop Area -->
                    <div id="drop-zone" class="border-2 border-dashed p-5 text-center rounded mb-3" 
                         style="border-color: #dee2e6; cursor: pointer; background-color: #f8f9fa; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                        <div>
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="lead mb-2">Arraste seu arquivo CSV aqui</p>
                            <p class="text-muted mb-3">ou</p>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                                <i class="fas fa-folder-open"></i> Selecionar Arquivo
                            </button>
                            <input type="file" id="file-input" accept=".csv" style="display: none;">
                        </div>
                    </div>

                    <!-- File Info -->
                    <div id="file-info" class="alert alert-info d-none" role="alert">
                        <i class="fas fa-check-circle"></i>
                        <strong>Arquivo selecionado:</strong> <span id="file-name"></span>
                        <span id="file-size" class="text-muted ml-2"></span>
                    </div>

                    <!-- Preview Table -->
                    <div id="preview-container" class="d-none">
                        <h6 class="mt-4 mb-3">
                            <i class="fas fa-eye"></i> Preview do Arquivo
                            <span class="badge badge-secondary" id="preview-count"></span>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="preview-table">
                                <thead class="table-light">
                                    <tr id="preview-header"></tr>
                                </thead>
                                <tbody id="preview-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button type="button" class="btn btn-success btn-lg" id="upload-btn" disabled>
                    <i class="fas fa-upload"></i> Upload de Processos
                </button>
                <button type="button" class="btn btn-secondary btn-lg" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>

            <!-- Progress -->
            <div id="progress-container" class="d-none">
                <h6>Carregando...</h6>
                <div class="progress">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Results -->
            <div id="results-container" class="d-none">
                <div class="alert" id="results-alert" role="alert">
                    <h5 id="results-title"></h5>
                    <p id="results-message"></p>
                    <div id="results-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #drop-zone {
        transition: all 0.3s ease;
    }

    #drop-zone.drag-over {
        background-color: #e7f3ff !important;
        border-color: #0066cc !important;
        transform: scale(1.02);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .badge-secondary {
        margin-left: auto;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const uploadBtn = document.getElementById('upload-btn');
    const previewContainer = document.getElementById('preview-container');
    const progressContainer = document.getElementById('progress-container');
    const resultsContainer = document.getElementById('results-container');

    let selectedFile = null;

    // Drag and Drop Events
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        handleFile(e.target.files[0]);
    });

    function handleFile(file) {
        if (!file) return;

        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Por favor, selecione um arquivo CSV válido');
            return;
        }

        selectedFile = file;
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
        fileInfo.classList.remove('d-none');

        // Preview
        previewFile(file);
    }

    function previewFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const csv_content = e.target.result;

            // Enviar para preview API
            const formData = new FormData();
            formData.append('csv_file', file);

            fetch(`/processos/api/{{ id_cliente }}/bulk-upload/preview`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'sucesso') {
                    displayPreview(data);
                    uploadBtn.disabled = false;
                } else {
                    alert('Erro ao visualizar: ' + data.mensagem);
                }
            })
            .catch(error => console.error('Erro:', error));
        };
        reader.readAsArrayBuffer(file);
    }

    function displayPreview(data) {
        const headerRow = document.getElementById('preview-header');
        const bodyRows = document.getElementById('preview-body');
        headerRow.innerHTML = '';
        bodyRows.innerHTML = '';

        // Header
        if (data.colunas) {
            data.colunas.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
        }

        // Rows
        data.preview.forEach(row => {
            const tr = document.createElement('tr');
            data.colunas.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] || '-';
                tr.appendChild(td);
            });
            bodyRows.appendChild(tr);
        });

        document.getElementById('preview-count').textContent = 
            `${data.preview.length} de ${data.total_linhas} linhas`;
        previewContainer.classList.remove('d-none');
    }

    uploadBtn.addEventListener('click', uploadFile);

    function uploadFile() {
        if (!selectedFile) return;

        uploadBtn.disabled = true;
        progressContainer.classList.remove('d-none');
        resultsContainer.classList.add('d-none');

        const formData = new FormData();
        formData.append('csv_file', selectedFile);

        fetch(`/processos/api/{{ id_cliente }}/bulk-upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            progressContainer.classList.add('d-none');
            displayResults(data);
        })
        .catch(error => {
            progressContainer.classList.add('d-none');
            displayResults({
                status: 'erro',
                mensagem: 'Erro na comunicação: ' + error.message,
                processos_criados: 0,
                erros: [error.message]
            });
        });
    }

    function displayResults(data) {
        const alert = document.getElementById('results-alert');
        const title = document.getElementById('results-title');
        const message = document.getElementById('results-message');
        const list = document.getElementById('results-list');

        if (data.status === 'sucesso') {
            alert.className = 'alert alert-success';
            title.innerHTML = '<i class="fas fa-check-circle"></i> Upload Concluído com Sucesso!';
            message.textContent = `${data.processos_criados} processo(s) criado(s).`;
        } else {
            alert.className = 'alert alert-danger';
            title.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro ao Processar Upload';
            message.textContent = data.mensagem || 'Erro desconhecido';
        }

        // Errors
        if (data.erros && data.erros.length > 0) {
            list.innerHTML = '<div class="mt-3"><strong>Erros encontrados:</strong><ul class="mt-2">';
            data.erros.forEach(erro => {
                list.innerHTML += `<li>${erro}</li>`;
            });
            list.innerHTML += '</ul></div>';
        }

        // Created IDs
        if (data.ids_criados && data.ids_criados.length > 0) {
            list.innerHTML += '<div class="mt-3"><strong>Processos Criados:</strong><ul class="mt-2">';
            data.ids_criados.slice(0, 20).forEach(id => {
                list.innerHTML += `<li><code>${id}</code></li>`;
            });
            if (data.ids_criados.length > 20) {
                list.innerHTML += `<li><em>... e mais ${data.ids_criados.length - 20} processos</em></li>`;
            }
            list.innerHTML += '</ul></div>';
        }

        // Botão de notificação por email
        if (data.processos_criados > 0) {
            list.innerHTML += `
                <div class="mt-4">
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="sendEmailNotification('${data.processos_criados}', ${JSON.stringify(data.ids_criados || [])}, ${JSON.stringify(data.erros || [])})">
                        <i class="fas fa-envelope"></i> Enviar Relatório por Email
                    </button>
                </div>
            `;
        }

        resultsContainer.classList.remove('d-none');
    }

    function sendEmailNotification(processosCriados, idsCriados, erros) {
        const payload = {
            processos_criados: parseInt(processosCriados),
            ids_criados: idsCriados,
            erros: erros
        };

        fetch(`/processos/api/{{ id_cliente }}/bulk-upload/notify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                alert('✓ Email enviado com sucesso!');
            } else if (data.status === 'aviso') {
                alert('⚠️ ' + data.mensagem);
            } else {
                alert('✗ Erro ao enviar email: ' + data.mensagem);
            }
        })
        .catch(error => {
            alert('Erro na comunicação: ' + error.message);
        });
    }
});
</script>
{% endblock %}
