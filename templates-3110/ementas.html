{% extends 'base.html' %}
{% block title %}Pesquisa de Ementas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Pesquisa de Ementas por Similaridade</h2>
  <a href="/clientes/" class="btn btn-sm btn-outline-secondary">Voltar</a>
</div>

<div class="row">
  <!-- COL ESQUERDA -->
  <div class="col-lg-4">

    <!-- Gerenciar Base -->
    <div class="card mb-3">
      <div class="card-header">Gerenciar Base de Ementas</div>
      <div class="card-body">
        <form hx-post="/ementas/ui/upload" hx-target="#ementa-files" hx-swap="innerHTML" enctype="multipart/form-data">
          <label class="form-label small">Selecione PDFs ou TXT (múltiplos)</label>
          <input class="form-control form-control-sm mb-2" type="file" name="files" multiple required>
          <button class="btn btn-primary btn-sm" type="submit">Indexar Novas Ementas</button>
        </form>
      </div>
    </div>

    <!-- Buscar Ementas (HTMX “clássico”) -->
    <div class="card mb-3">
      <div class="card-header">Buscar Ementas</div>
      <div class="card-body">
        <form id="form-busca-ementas" hx-post="/ementas/ui/buscar" hx-target="#resultados-busca" hx-swap="innerHTML">
          <div class="form-check form-check-inline small">
            <input class="form-check-input" type="radio" name="mode" id="mode-manual" value="manual" checked>
            <label class="form-check-label" for="mode-manual">Digitar/Colar Texto</label>
          </div>
          <div class="form-check form-check-inline small mb-2">
            <input class="form-check-input" type="radio" name="mode" id="mode-resumo" value="resumo"
                   hx-get="/ementas/ui/resumo/kb_dummy" hx-target="#query-container" hx-swap="innerHTML">
            <label class="form-check-label" for="mode-resumo">Usar Resumo do Caso Ativo</label>
          </div>

          <div id="query-container">
            <textarea name="q" id="ementa-query-box" rows="5" class="form-control form-control-sm mb-2"
                      placeholder="Digite ou cole o texto base da sua tese"></textarea>
          </div>

          <div class="input-group input-group-sm mb-2" style="max-width:200px;">
            <span class="input-group-text">Top K</span>
            <input type="number" name="k" value="5" min="1" max="20" class="form-control">
          </div>

          <input type="hidden" name="case_id" value="kb_dummy">
          <button class="btn btn-outline-secondary btn-sm" type="submit">Buscar</button>
        </form>
      </div>
    </div>

    <!-- Pesquisa Avançada (FAISS) -->
    <div class="card mb-3 bg-dark text-light border-secondary">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Pesquisa Avançada (FAISS / Similaridade)</strong>
        <div class="small">
          <span id="faiss-status" class="text-info"></span>
        </div>
      </div>
      <div class="card-body">
        <form id="faiss-form" onsubmit="return false;">
          <div class="mb-2">
            <label class="form-label small text-muted">Texto base da consulta</label>
            <textarea id="faiss-query" class="form-control form-control-sm bg-secondary text-light" rows="4"
              placeholder="Ex: ação de indenização por danos morais em contrato bancário"></textarea>
          </div>

          <div class="input-group input-group-sm mb-2" style="max-width:220px;">
            <span class="input-group-text">Top K</span>
            <input type="number" id="faiss-topk" value="10" min="1" max="50"
                   class="form-control bg-secondary text-light">
          </div>

          <div class="d-flex gap-2">
            <button id="btn-faiss-search" class="btn btn-primary btn-sm">Buscar Similar</button>
            <button id="btn-faiss-clear"  class="btn btn-outline-light btn-sm" type="button">Limpar</button>
            <button id="btn-faiss-export" class="btn btn-outline-info btn-sm" type="button">Exportar CSV</button>
          </div>
        </form>

        <div id="faiss-alert" class="alert d-none mt-3" role="alert"></div>

        <div class="table-responsive mt-3">
          <table class="table table-dark table-hover table-sm align-middle">
            <thead class="table-secondary text-dark">
              <tr>
                <th style="width:5%">#</th>
                <th style="width:20%">Título</th>
                <th>Ementa (trecho)</th>
                <th style="width:10%">Score</th>
                <th style="width:25%">Meta</th>
              </tr>
            </thead>
            <tbody id="faiss-results-body">
              <tr class="text-muted">
                <td colspan="5">(Nenhum resultado ainda)</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- COL DIREITA -->
  <div class="col-lg-8">
    <div class="accordion mb-3" id="accEmentas">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headListEmentas">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseListEmentas" aria-expanded="false" aria-controls="collapseListEmentas">
            Arquivos Indexados ({{ ementa_files|length }})
          </button>
        </h2>
        <div id="collapseListEmentas" class="accordion-collapse collapse" aria-labelledby="headListEmentas"
             data-bs-parent="#accEmentas">
          <div class="accordion-body p-2">
            <div id="ementa-files">
              {% include '_lista_ementas.html' %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <h5 class="mb-2">Resultados (mecanismo HTMX)</h5>
    <div id="resultados-busca" class="small text-muted">(Nenhuma busca ainda)</div>
  </div>
</div>

<!-- Modal: Ementa Completa -->
<div class="modal fade" id="ementaModal" tabindex="-1" aria-labelledby="ementaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="ementaModalLabel">Ementa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <pre id="ementaModalBody" class="mb-0" style="white-space: pre-wrap;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- JS do widget FAISS -->
<script>
(function(){
  const form     = document.getElementById("faiss-form");
  const qEl      = document.getElementById("faiss-query");
  const kEl      = document.getElementById("faiss-topk");
  const alertEl  = document.getElementById("faiss-alert");
  const tbody    = document.getElementById("faiss-results-body");
  const statusEl = document.getElementById("faiss-status");
  const btnSearch= document.getElementById("btn-faiss-search");
  const btnClear = document.getElementById("btn-faiss-clear");
  const btnExport= document.getElementById("btn-faiss-export");

  let lastResults = [];

  function setStatus(msg){ statusEl.textContent = msg || ""; }
  function showError(msg) {
    alertEl.classList.remove("d-none");
    alertEl.classList.add("alert-danger");
    alertEl.classList.remove("alert-info");
    alertEl.textContent = msg;
  }
  function hideError() {
    alertEl.classList.add("d-none");
    alertEl.classList.remove("alert-danger", "alert-info");
    alertEl.textContent = "";
  }
  function clearRows() {
    tbody.innerHTML = '<tr class="text-muted"><td colspan="5">(Nenhum resultado ainda)</td></tr>';
    lastResults = [];
  }

  function colorForScore(s){
    if (s >= 0.75) return "limegreen";
    if (s >= 0.55) return "orange";
    return "gray";
  }

  function openModal(title, text){
    const modalEl = document.getElementById("ementaModal");
    document.getElementById("ementaModalLabel").textContent = title || "(Sem título)";
    document.getElementById("ementaModalBody").textContent  = text || "";
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  function render(results){
    if (!results || results.length === 0) { clearRows(); return; }
    tbody.innerHTML = "";
    results.forEach((r) => {
      const score = (typeof r.score === "number") ? r.score : parseFloat(r.score || "0");
      const ementaShort = r.ementa || "";
      const ementaFull  = r.ementa_full || r.ementa || "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.rank ?? ""}</td>
        <td>
          <a href="#" class="link-info text-decoration-none"
             onclick="event.preventDefault(); window.__verEmenta('${(r.title||'').replace(/'/g, "\\'")}','${(ementaFull||'').replace(/'/g, "\\'")}')">
            ${r.title ?? ""}
          </a>
          <div class="small text-muted">id=${r.id ?? ""}</div>
        </td>
        <td>${ementaShort}</td>
        <td style="color:${colorForScore(score)}">${isNaN(score) ? "" : score.toFixed(4)}</td>
        <td>
          <div class="small text-muted">${r.orgao ?? ""}${r.grupo ? " • " + r.grupo : ""}</div>
          <div class="small text-muted">${r.data_decisao ?? ""}</div>
          ${r.source ? `<div class="small text-muted">src: ${r.source}</div>` : ""}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Disponibiliza função global usada pelo link do título
  window.__verEmenta = openModal;

  async function doSearch(){
    hideError();
    setStatus("Consultando…");
    btnSearch.disabled = true;

    const query = (qEl.value || "").trim();
    const top_k = parseInt(kEl.value || "10", 10);

    if (!query) {
      showError("Digite um texto para consulta.");
      setStatus("");
      btnSearch.disabled = false;
      return;
    }

    try {
      const resp = await fetch("/ementas/faiss/buscar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ query, top_k })
      });

      const ct = resp.headers.get("content-type") || "";
      if (!resp.ok) {
        const txt = await resp.text();
        showError(`HTTP ${resp.status}: ${txt.slice(0, 160)}…`);
        setStatus("");
        btnSearch.disabled = false;
        return;
      }
      if (!ct.includes("application/json")) {
        const txt = await resp.text();
        showError("Resposta não-JSON recebida: " + txt.slice(0, 160) + "…");
        setStatus("");
        btnSearch.disabled = false;
        return;
      }

      const j = await resp.json();
      if (!j.ok) {
        showError(j.error || "Falha desconhecida");
        setStatus("");
        btnSearch.disabled = false;
        return;
      }

      lastResults = j.results || [];
      render(lastResults);
      setStatus(`${lastResults.length} resultado(s)`);

    } catch (err) {
      showError(String(err));
    } finally {
      btnSearch.disabled = false;
    }
  }

  function toCSV(rows){
    if (!rows || rows.length === 0) return "";
    const header = ["rank","id","title","score","orgao","grupo","data_decisao","source","ementa"];
    const esc = (s) => ('"' + String(s ?? "").replace(/"/g,'""') + '"');
    const body = rows.map(r => [
      r.rank, r.id, r.title,
      (typeof r.score === "number" ? r.score.toFixed(4) : r.score),
      r.orgao, r.grupo, r.data_decisao, r.source,
      (r.ementa_full || r.ementa || "")
    ].map(esc).join(","));
    return header.join(",") + "\n" + body.join("\n");
  }

  function download(filename, text){
    const blob = new Blob([text], {type: "text/csv;charset=utf-8;"});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Eventos
  form.addEventListener("submit", (ev) => { ev.preventDefault(); doSearch(); });
  btnClear.addEventListener("click", () => { qEl.value = ""; hideError(); clearRows(); setStatus(""); });
  btnExport.addEventListener("click", () => {
    if (!lastResults.length) { showError("Não há resultados para exportar."); return; }
    hideError();
    const csv = toCSV(lastResults);
    download("ementas_similares.csv", csv);
  });
})();
</script>
{% endblock %}
