{% extends "base.html" %}
{% block title %}Busca por Similaridade (Ementas){% endblock %}

{% block content %}
<div class="container" style="max-width: 1080px; margin: 24px auto;">
  <h2 style="margin:0 0 12px;">Pesquisa de Ementas por Similaridade</h2>
  <div style="font-size: 12px; color:#6b7280;">
    Índice: {{ info.store }} • Dimensão: {{ info.dim or "?" }} • Docs: {{ info.meta or 0 }}
    {% if info.error %} • <span style="color:#dc2626">Erro: {{ info.error }}</span>{% endif %}
  </div>

  <div style="margin-top:16px; padding:16px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;">
    <label for="query" style="display:block; font-weight:600; margin-bottom:6px;">Texto da consulta</label>
    <textarea id="query" rows="4" style="width:100%; border:1px solid #d1d5db; border-radius:10px; padding:10px;"
      placeholder="Digite a tese/resumo do caso..."></textarea>

    <div style="display:flex; gap:12px; align-items:center; margin-top:10px;">
      <label for="topk">Top-K</label>
      <input id="topk" type="number" min="1" max="50" value="10"
             style="width:80px; border:1px solid #d1d5db; border-radius:8px; padding:6px;">
      <button id="btnBuscar" class="btn btn-primary"
              style="padding:8px 14px; border-radius:10px; border:1px solid #2563eb; background:#2563eb; color:#fff;">
        Buscar
      </button>
      <button id="btnLimpar"
              style="padding:8px 14px; border-radius:10px; border:1px solid #e5e7eb; background:#fff;">
        Limpar
      </button>
    </div>
  </div>

  <div id="status" style="margin:14px 0; color:#6b7280; font-size:13px;"></div>

  <div id="results"></div>
</div>

<script>
// util: cria um trecho destacado
function makeSnippet(text, q, maxLen=360) {
  if (!text) return "";
  const t = text.replace(/\s+/g," ").trim();
  if (!q) return t.slice(0, maxLen) + (t.length>maxLen ? "..." : "");
  const i = t.toLowerCase().indexOf(q.toLowerCase());
  if (i < 0) return t.slice(0, maxLen) + (t.length>maxLen ? "..." : "");
  const start = Math.max(0, i - Math.floor(maxLen/3));
  const end = Math.min(t.length, i + q.length + Math.floor(maxLen/3*2));
  let seg = t.slice(start, end);
  // destaque simples
  const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "ig");
  seg = seg.replace(re, m => `<mark>${m}</mark>`);
  return (start>0 ? "…" : "") + seg + (end<t.length ? "…" : "");
}

async function buscar() {
  const query = document.getElementById('query').value.trim();
  const topk = parseInt(document.getElementById('topk').value || "10", 10);
  const status = document.getElementById('status');
  const results = document.getElementById('results');

  if (!query) {
    status.innerHTML = `<span style="color:#dc2626">Digite um texto de consulta.</span>`;
    return;
  }

  status.textContent = 'Buscando…';
  results.innerHTML = '';

  try {
    const r = await fetch('/ementas/faiss/buscar', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query, top_k: topk })
    });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    const items = data.results || [];

    status.innerHTML = `✅ ${items.length} resultado(s) (top-${data.top_k})`;

    if (!items.length) {
      results.innerHTML = '<div style="color:#6b7280;">Nenhum resultado.</div>';
      return;
    }

    // tabela simples
    let html = `
      <div style="margin-top:10px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;">
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead style="background:#f9fafb;">
            <tr>
              <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">#</th>
              <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">Título</th>
              <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; width:58%;">Trecho</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">Score</th>
            </tr>
          </thead>
          <tbody>
    `;
    for (const r of items) {
      const title = (r.title || r.doc_id || '(sem título)');
      const snippet = makeSnippet(r.text || '', query);
      html += `
        <tr>
          <td style="padding:10px; border-top:1px solid #f3f4f6;">${r.rank}</td>
          <td style="padding:10px; border-top:1px solid #f3f4f6;">
            <div style="font-weight:600;">${title}</div>
            ${r.metadata && r.metadata.orgao ? `<div style="color:#6b7280; font-size:12px;">${r.metadata.orgao}</div>` : ``}
          </td>
          <td style="padding:10px; border-top:1px solid #f3f4f6; color:#374151;">
            ${snippet}
          </td>
          <td style="padding:10px; border-top:1px solid #f3f4f6; text-align:right;">
            ${r.score.toFixed(4)}
          </td>
        </tr>
      `;
    }
    html += `</tbody></table></div>`;
    results.innerHTML = html;

  } catch (err) {
    status.innerHTML = `<span style="color:#dc2626">Erro: ${err}</span>`;
  }
}

document.getElementById('btnBuscar').addEventListener('click', buscar);
document.getElementById('btnLimpar').addEventListener('click', () => {
  document.getElementById('query').value = '';
  document.getElementById('results').innerHTML = '';
  document.getElementById('status').textContent = '';
});
</script>
{% endblock %}
