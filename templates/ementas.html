{% extends 'base.html' %}
{% block title %}Pesquisa de Ementas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Pesquisa de Ementas por Similaridade</h2>
  <a href="/clientes/" class="btn btn-sm btn-outline-secondary">Voltar</a>
</div>

<div class="row">
  <!-- COL ESQUERDA -->
  <div class="col-lg-4">

    <!-- Gerenciar Base -->
    <div class="card mb-3">
      <div class="card-header">Gerenciar Base de Ementas</div>
      <div class="card-body">
        <form hx-post="/ementas/ui/upload" hx-target="#ementa-files" hx-swap="innerHTML" enctype="multipart/form-data">
          <label class="form-label small">Selecione PDFs ou TXT (m√∫ltiplos)</label>
          <input class="form-control form-control-sm mb-2" type="file" name="files" multiple required>
          <button class="btn btn-primary btn-sm" type="submit">Indexar Novas Ementas</button>
        </form>
      </div>
    </div>

    <!-- Buscar Ementas (HTMX ‚Äúcl√°ssico‚Äù) -->
    <div class="card mb-3">
      <div class="card-header">Buscar Ementas</div>
      <div class="card-body">
        <form id="form-busca-ementas" hx-post="/ementas/ui/buscar" hx-target="#resultados-busca" hx-swap="innerHTML">
          <div class="form-check form-check-inline small">
            <input class="form-check-input" type="radio" name="mode" id="mode-manual" value="manual" checked>
            <label class="form-check-label" for="mode-manual">Digitar/Colar Texto</label>
          </div>
          <div class="form-check form-check-inline small mb-2">
            <input class="form-check-input" type="radio" name="mode" id="mode-resumo" value="resumo"
                   hx-get="/ementas/ui/resumo/kb_dummy" hx-target="#query-container" hx-swap="innerHTML">
            <label class="form-check-label" for="mode-resumo">Usar Resumo do Caso Ativo</label>
          </div>

          <div id="query-container">
            <textarea name="q" id="ementa-query-box" rows="5" class="form-control form-control-sm mb-2"
                      placeholder="Digite ou cole o texto base da sua tese"></textarea>
          </div>

          <div class="input-group input-group-sm mb-2" style="max-width:200px;">
            <span class="input-group-text">Top K</span>
            <input type="number" name="k" value="5" min="1" max="20" class="form-control">
          </div>

          <input type="hidden" name="case_id" value="kb_dummy">
          <button class="btn btn-outline-secondary btn-sm" type="submit">Buscar</button>
        </form>
      </div>
    </div>

    <!-- Pesquisa Avan√ßada (FAISS) -->
    <!-- Pesquisa Avan√ßada (FAISS) -->
<!-- ====== IN√çCIO: Pesquisa Avan√ßada (FAISS / Similaridade) ====== -->
<div class="card mb-3 bg-dark text-light border-secondary">
  <div class="card-header">
    <strong>Pesquisa Avan√ßada (FAISS / Similaridade)</strong>
  </div>

  <div class="card-body">
    <!-- ALERTA (erros/avisos) -->
    <div id="faiss-alert" class="alert d-none" role="alert"></div>

    <!-- FORM -->
    <form id="faiss-form" onsubmit="return false;">
      <div class="mb-2">
        <label class="form-label small text-muted">Texto base da consulta</label>
        <textarea id="faiss-query"
                  class="form-control form-control-sm bg-secondary text-light"
                  rows="5"
                  placeholder="Ex.: a√ß√£o de indeniza√ß√£o por danos morais em contrato banc√°rio"></textarea>
      </div>

      <div class="row g-2 align-items-end">
        <div class="col-sm-6 col-md-4">
          <label class="form-label small">Case ID</label>
          <input type="text"
                 id="faiss-case-id"
                 class="form-control form-control-sm"
                 value=""
                 placeholder="caso_8d9e73b3 ou 8d9e73b3">
        </div>

        <div class="col-sm-3 col-md-2">
          <label class="form-label small">Top K</label>
          <input type="number"
                 id="faiss-topk"
                 class="form-control form-control-sm"
                 value="10" min="1" max="50">
        </div>

        <div class="col-sm-3 col-md-3 d-grid">
          <label class="form-label small">&nbsp;</label>
          <button id="btn-faiss-use-resumo" class="btn btn-outline-secondary btn-sm">
            Usar Resumo do Caso
          </button>
        </div>

        <div class="col-sm-12 col-md-3 d-grid">
          <label class="form-label small">&nbsp;</label>
          <button id="btn-faiss-search" class="btn btn-primary btn-sm">
            Buscar Similar
          </button>
        </div>
      </div>
    </form>

    <!-- RESULTADOS (HTML injetado do servidor: _faiss_cards.html) -->
    <div id="faiss-results" class="mt-3"></div>
  </div>
</div>
<!-- ====== FIM: Pesquisa Avan√ßada (FAISS / Similaridade) ====== -->


    <div id="faiss-alert" class="alert d-none mt-3" role="alert"></div>

    <!-- FAISS Results will be injected here -->
    <div id="faiss-results" class="mt-3"></div>
  </div>
</div>


  </div>

  <!-- COL DIREITA -->
  <div class="col-lg-8">
    <div class="accordion mb-3" id="accEmentas">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headListEmentas">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseListEmentas" aria-expanded="false" aria-controls="collapseListEmentas">
            Arquivos Indexados ({{ ementa_files|length }})
          </button>
        </h2>
        <div id="collapseListEmentas" class="accordion-collapse collapse" aria-labelledby="headListEmentas"
             data-bs-parent="#accEmentas">
          <div class="accordion-body p-2">
            <div id="ementa-files">
              {% include '_lista_ementas.html' %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <h5 class="mb-2">Resultados (mecanismo HTMX)</h5>
    <div id="resultados-busca" class="small text-muted">(Nenhuma busca ainda)</div>
  </div>
</div>

<!-- Modal: Ementa Completa -->
<div class="modal fade" id="ementaModal" tabindex="-1" aria-labelledby="ementaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="ementaModalLabel">Ementa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <pre id="ementaModalBody" class="mb-0" style="white-space: pre-wrap;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== SCRIPT do widget FAISS ====== -->
<script>
(function(){
  const qEl     = document.getElementById("faiss-query");
  const kEl     = document.getElementById("faiss-topk");
  const caseEl  = document.getElementById("faiss-case-id");
  const alertEl = document.getElementById("faiss-alert");
  const results = document.getElementById("faiss-results");

  function showErr(msg){
    if (!alertEl) return;
    alertEl.classList.remove("d-none");
    alertEl.classList.remove("alert-info");
    alertEl.classList.add("alert-danger");
    alertEl.textContent = msg;
  }
  function showInfo(msg){
    if (!alertEl) return;
    alertEl.classList.remove("d-none");
    alertEl.classList.remove("alert-danger");
    alertEl.classList.add("alert-info");
    alertEl.textContent = msg;
  }
  function clearAlert(){
    if (!alertEl) return;
    alertEl.classList.add("d-none");
    alertEl.textContent = "";
    alertEl.classList.remove("alert-danger","alert-info");
  }

  function autoFillCaseId(){
    if (caseEl && (!caseEl.value || !caseEl.value.trim())) {
      const m = location.pathname.match(/\/processos\/painel\/([^\/]+)/);
      if (m && m[1]) {
        caseEl.value = m[1]; // Will be full "caso_8d9e73b3" from URL
      }
    }
  }
  autoFillCaseId();

  // Buscar Similar
  document.getElementById("btn-faiss-search")?.addEventListener("click", async (ev)=>{
    ev.preventDefault();
    clearAlert();
    const query = (qEl?.value || "").trim();
    const top_k = parseInt(kEl?.value || "10", 10);
    if (!query) { showErr("Digite um texto ou use o Resumo do Caso."); return; }

    try {
      showInfo("Buscando‚Ä¶");
      const resp = await fetch("/ementas/faiss/ui/buscar", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({ q: query, k: String(top_k) })
      });
      const html = await resp.text();
      results.innerHTML = html;
      
      // Add bulk export button if there are results
      if (html.includes('card-body')) {
        const exportBtn = document.createElement('div');
        exportBtn.innerHTML = `
          <div class="mt-3 mb-2 d-flex justify-content-end">
            <button id="btn-faiss-export-all" class="btn btn-sm btn-outline-warning" 
                    data-query="${query}" data-k="${top_k}">
              üìÅ Baixar Todos (.TXT)
            </button>
          </div>
        `;
        results.insertBefore(exportBtn, results.firstChild);
        
        // Add event listener for bulk export
        document.getElementById("btn-faiss-export-all")?.addEventListener("click", (e) => {
          const btn = e.target;
          const query = btn.dataset.query;
          const k = btn.dataset.k;
          
          // Create form for bulk download
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/ementas/faiss/ui/export_all_txt';
          form.style.display = 'none';
          
          const queryInput = document.createElement('input');
          queryInput.type = 'hidden';
          queryInput.name = 'query';
          queryInput.value = query;
          
          const kInput = document.createElement('input');
          kInput.type = 'hidden';
          kInput.name = 'k';
          kInput.value = k;
          
          form.appendChild(queryInput);
          form.appendChild(kInput);
          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);
          
          // Visual feedback
          btn.innerHTML = 'üìÅ Preparando...';
          btn.disabled = true;
          setTimeout(() => {
            btn.innerHTML = 'üìÅ Baixar Todos (.TXT)';
            btn.disabled = false;
          }, 3000);
        });
      }
      
      clearAlert();
    } catch (e) {
      showErr("Falha na busca: " + String(e));
    }
  });

  // Usar Resumo do Caso
  document.getElementById("btn-faiss-use-resumo")?.addEventListener("click", async (ev)=>{
    ev.preventDefault();
    clearAlert();
    const cid = (caseEl?.value || "").trim();
    if (!cid) { showErr("Informe/valide o Case ID."); return; }

    try {
      showInfo("Buscando resumo do caso‚Ä¶");
      const resp = await fetch(`/ementas/faiss/resumo?case_id=${encodeURIComponent(cid)}`);
      if (!resp.ok) {
        showErr(`N√£o foi poss√≠vel obter o resumo (HTTP ${resp.status}).`);
        return;
      }
      const j = await resp.json();
      if (!j.ok) {
        showErr(j.error || "Resumo indispon√≠vel.");
        return;
      }
      qEl.value = j.resumo || "";
      clearAlert();
    } catch (e) {
      showErr("Falha ao obter resumo: " + String(e));
    }
  });
})();
</script>
<!-- ====== FIM SCRIPT ====== -->

{% endblock %}
